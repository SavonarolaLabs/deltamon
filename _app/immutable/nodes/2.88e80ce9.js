import{s as k,f as Q,g as J,h as Z,d as Y,j as g,i as ee,y as I,o as te,A as re,p as ne}from"../chunks/scheduler.9ee62574.js";import{S as V,i as H,b as ae,d as oe,m as ie,a as se,t as ce,e as ue}from"../chunks/index.9ced2dbd.js";import{s as fe,g as p}from"../chunks/gameloop.45755ab9.js";function q(e){const t=[-.5,.5,-.5,-.5,.5,.5,.5,-.5],n=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,n),e.bufferData(e.ARRAY_BUFFER,new Float32Array(t),e.STATIC_DRAW);const r=[0,0,0,1,1,0,1,1],a=e.createBuffer();return e.bindBuffer(e.ARRAY_BUFFER,a),e.bufferData(e.ARRAY_BUFFER,new Float32Array(r),e.STATIC_DRAW),{positionBuffer:n,textureCoordBuffer:a}}function de(e){const t=`
		attribute vec4 aVertexPosition;
		attribute vec2 aTextureCoord;
		varying highp vec2 vTextureCoord;
		void main(void) {
			gl_Position = aVertexPosition;
			vTextureCoord = aTextureCoord;
		}
	`,n=`
		varying highp vec2 vTextureCoord;
		uniform sampler2D uSampler;
		uniform highp float uWhiteFlash; // New uniform for white flash effect

		void main(void) {
			// Sample the texture color
			highp vec4 texColor = texture2D(uSampler, vTextureCoord);

			// Blend texture color with white based on uWhiteFlash value
			highp vec4 whiteColor = vec4(1.0, 1.0, 1.0, texColor.a);
			gl_FragColor = mix(texColor, whiteColor, uWhiteFlash);
		}
	`,r=N(e,e.VERTEX_SHADER,t),a=N(e,e.FRAGMENT_SHADER,n),o=e.createProgram();return e.attachShader(o,r),e.attachShader(o,a),e.linkProgram(o),e.getProgramParameter(o,e.LINK_STATUS)?(e.useProgram(o),o):(console.error("Unable to initialize the shader program:",e.getProgramInfoLog(o)),null)}function N(e,t,n){const r=e.createShader(t);return r?(e.shaderSource(r,n),e.compileShader(r),e.getShaderParameter(r,e.COMPILE_STATUS)?r:(console.error("An error occurred compiling the shaders:",e.getShaderInfoLog(r)),e.deleteShader(r),null)):(console.error("Unable to create shader"),null)}function me(e){const t=e.getContext("webgl",{alpha:!0});if(!t)return console.error("Unable to initialize WebGL. Your browser may not support it."),null;he(e),t.viewport(0,0,t.canvas.width,t.canvas.height);const n=de(t);if(!n)return console.error("Failed to initialize shader program"),null;const r=q(t);return t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),t.clearColor(0,0,0,1),t.clear(t.COLOR_BUFFER_BIT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),{gl:t,shaderProgram:n,buffers:r}}function he(e){const{width:t,height:n}=e.getBoundingClientRect(),r=window.devicePixelRatio||1;e.width=t*r,e.height=n*r,e.style.width=`${t}px`,e.style.height=`${n}px`}function le(e,t,n,r,a){const o=e.canvas.width,u=e.canvas.height,d=1792,s=1024,i=d/o,h=s/u;let m,T;i<h?(m=2,T=h/i*2):(T=2,m=i/h*2),e.bindBuffer(e.ARRAY_BUFFER,n);const S=new Float32Array([-m/2,T/2,-m/2,-T/2,m/2,T/2,m/2,-T/2]);e.bufferData(e.ARRAY_BUFFER,S,e.STATIC_DRAW);const v=e.getAttribLocation(t,"aVertexPosition");e.enableVertexAttribArray(v),e.vertexAttribPointer(v,2,e.FLOAT,!1,0,0),a&&e.bindTexture(e.TEXTURE_2D,a),e.bindBuffer(e.ARRAY_BUFFER,r);const P=e.getAttribLocation(t,"aTextureCoord");e.enableVertexAttribArray(P),e.vertexAttribPointer(P,2,e.FLOAT,!1,0,0);const F=e.getUniformLocation(t,"uSampler");e.uniform1i(F,0),e.drawArrays(e.TRIANGLE_STRIP,0,4)}let D,B,X,L,W;function Te(e,t){({positionBuffer:D,textureCoordBuffer:B}=q(e)),X=e.getAttribLocation(t,"aVertexPosition"),L=e.getAttribLocation(t,"aTextureCoord"),W=e.getUniformLocation(t,"uSampler"),e.enableVertexAttribArray(X),e.enableVertexAttribArray(L),e.uniform1i(W,0)}function Ae(e,t,n,r,a,o){n.clear(n.COLOR_BUFFER_BIT);const u=a["/bg/current.png"];u&&le(n,r,D,B,u),t.slice().sort((s,i)=>s.zIndex-i.zIndex).forEach(s=>{const i=a[s.texturePath];i?G(n,r,D,B,i,s.x,s.y,s.scale,X,L,s.whiteFlash):console.warn(`Texture not found for path: ${s.texturePath}`)});for(let s of o.sort((i,h)=>i.z-h.z))if(s.draw){const i=a[s.texturePath];i?G(n,r,D,B,i,s.x,s.y,s.scale,X,L):console.warn(`${s.texturePath} not in textures[].`)}}function G(e,t,n,r,a,o,u,d,s,i,h=0){const{scaleX:m,scaleY:T}=Ee(e,d);pe(e,n,o,u,m,T,s),Re(e,a,r,i);const S=e.getUniformLocation(t,"uWhiteFlash");e.uniform1f(S,h),e.drawArrays(e.TRIANGLE_STRIP,0,4)}function Ee(e,t,n){const r=e.canvas.width/e.canvas.height,a=614/868;let o=t,u=o/a;return r>1?o/=r:u*=r,{scaleX:o,scaleY:u}}function pe(e,t,n,r,a,o,u){e.bindBuffer(e.ARRAY_BUFFER,t);const d=new Float32Array([-a+n,o+r,-a+n,-o+r,a+n,o+r,a+n,-o+r]);e.bufferData(e.ARRAY_BUFFER,d,e.STATIC_DRAW),e.vertexAttribPointer(u,2,e.FLOAT,!1,0,0)}function Re(e,t,n,r){e.bindTexture(e.TEXTURE_2D,t),e.bindBuffer(e.ARRAY_BUFFER,n),e.vertexAttribPointer(r,2,e.FLOAT,!1,0,0)}const $=[{name:"flame10",path:"/abilities/flame10",frameCount:41},{name:"flame2",path:"/abilities/flame2",frameCount:16}],_e=["/monster/card_001.png","/monster/card_002.png","/monster/card_003.png","/bg/current.png"];function z(e,t){return new Promise((n,r)=>{const a=e.createTexture();if(!a){r(new Error("Failed to create texture"));return}const o=new Image;o.crossOrigin="anonymous",o.src=t,o.onload=()=>{e.bindTexture(e.TEXTURE_2D,a),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,o),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),n(a)},o.onerror=()=>{r(new Error(`Failed to load texture from ${t}`))}})}async function xe(e){const t={};await Promise.all(_e.map(async n=>{t[n]=await z(e,n)}));for(const n of $){const{path:r,frameCount:a}=n;await Promise.all(Array.from({length:a}).map(async(o,u)=>{const d=`${u.toString().padStart(4,"0")}.png`,s=`${r}/${d}`;t[s]=await z(e,s)}))}return t}function be(e,t=1,n=0){const r=new Audio(e);r.playbackRate=t,r.currentTime=n,r.play()}function Se(e,t){setTimeout(()=>{new Audio(e).play()},t)}const Fe=450,we=200;function ve(){return{currentFrame:0,duration:Fe,lastTime:0,startX:-.45,startY:.7,endX:.35,abilityFolder:$.find(e=>e.name=="flame10"),texturePath:"/abilities/flame10/0000.png",x:-.45,y:.7,scale:.5,draw:!0,z:1}}function Pe(e){return{currentFrame:0,duration:we,lastTime:0,startX:e.endX*1.4,startY:e.startY,endX:e.endX,abilityFolder:$.find(t=>t.name=="flame2"),texturePath:"/abilities/flame2/0000.png",x:e.endX*1.4,y:e.startY*.9,scale:.7,draw:!0,z:0}}const E=.15,R=.8,_=R-.3,b=.55,C=b-.45,U=b-.45*2,ye=[[-R,b],[-_,b],[_,b],[R,b],[-R,C-E],[-_,C-E],[_,C-E],[R,C-E],[-R,U-E*2],[-_,U-E*2],[_,U-E*2],[R,U-E*2]],Ce=[0,1,4,5,8,9,2,3,6,7,10,11];function Ue(e){return e.slots.map((t,n)=>{var d;const r=((d=t.creature)==null?void 0:d.playerId)||0,a=t.creature?`/monster/${t.creature.img}`:"",[o,u]=Ie(n);return{slotIndex:n,playerId:r,texturePath:a,x:o,y:u,scale:.21,zIndex:0,isHovered:!1,originalX:o,originalY:u}})}function Ie(e){return ye[Ce[e]]}let M=null;function De(e,t){M||(M=t);const a=(t-M)*.003,o=6e-4*Math.sin(a);return{...e,scale:.24,y:e.y-o/2}}function Be(e){let t;return{c(){t=Q("canvas"),this.h()},l(n){t=J(n,"CANVAS",{class:!0}),Z(t).forEach(Y),this.h()},h(){g(t,"class","svelte-a3d4w5")},m(n,r){ee(n,t,r),e[1](t)},p:I,i:I,o:I,d(n){n&&Y(t),e[1](null)}}}const x=6,w=1,Xe=300,Le=.02,Me=200;function $e(e,t,n){let r,a,o,u,d={},s=[],i=[],h=null,m=null;const T=-.01;async function S(){const f=me(r);f&&({gl:a,shaderProgram:o,buffers:u}=f,d=await xe(a),Te(a,o),i=Ue(p),i[w].zIndex=10,requestAnimationFrame(F))}function v(){a&&Object.values(d).forEach(f=>a.deleteTexture(f)),d={}}function P(){be("/mp3/hadouken.mp3",1.1,.3);const f=ve();s.push(f),m=performance.now(),Se("/mp3/Beating Punch.mp3",350),setTimeout(()=>{const y=Pe(f);s.push(y),h=performance.now()},500)}function F(f){s.forEach(c=>{c.startTime||(c.startTime=f);const A=f-c.startTime,l=Math.min(A/c.duration,1);if(c.currentFrame=Math.floor(l*(c.abilityFolder.frameCount-1)),c.texturePath=`/abilities/${c.abilityFolder.name}/${c.currentFrame.toString().padStart(4,"0")}.png`,c.abilityFolder.name==="flame10"){if(l>.3){const j=(l-.3)/.7;c.x=c.startX+(c.endX-c.startX)*j}c.y=c.startY}l>=1&&(c.draw=!1)});const y=p.activeCreature;if(y){const c=p.slots.findIndex(A=>{var l;return((l=A.creature)==null?void 0:l.bcId)===y.bcId});c!==-1&&(i[c]=De(i[c],f))}if(m){const c=f-m,A=Math.min(c/Me,1),l=Math.sin(A*Math.PI);i[w].x=i[w].originalX+T*l,A>=1&&(i[w].x=i[w].originalX,m=null)}if(h){const c=f-h,A=Math.min(c/Xe,1),l=Math.sin(A*Math.PI);i[x].x=i[x].originalX+Le*l,i[x].whiteFlash=.9*(1-A),A>=1&&(i[x].x=i[x].originalX,i[x].whiteFlash=0,h=null)}s=s.filter(c=>c.draw),Ae(p,i,a,o,d,s),requestAnimationFrame(F)}function O(f){f.key.toUpperCase()==="Q"&&P()}te(()=>{fe(p),p.activeCreature=p.slots[1].creature,S(),window.addEventListener("keydown",O)}),re(()=>{window.cancelAnimationFrame(F),v(),a&&(a.deleteProgram(o),a.deleteBuffer(u.positionBuffer),a.deleteBuffer(u.textureCoordBuffer)),window.removeEventListener("keydown",O)});function K(f){ne[f?"unshift":"push"](()=>{r=f,n(0,r)})}return[r,K]}class Oe extends V{constructor(t){super(),H(this,t,$e,Be,k,{})}}function Ye(e){let t,n;return t=new Oe({}),{c(){ae(t.$$.fragment)},l(r){oe(t.$$.fragment,r)},m(r,a){ie(t,r,a),n=!0},p:I,i(r){n||(se(t.$$.fragment,r),n=!0)},o(r){ce(t.$$.fragment,r),n=!1},d(r){ue(t,r)}}}class ze extends V{constructor(t){super(),H(this,t,null,Ye,k,{})}}export{ze as component};
