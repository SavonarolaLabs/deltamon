import{s as ft,a as Ct,f as gt,c as Mt,g as Dt,h as Yt,d as V,j as Xt,i as it,y as dt,o as Ut,A as Lt,p as Bt}from"../chunks/scheduler.9ee62574.js";import{S as mt,i as ht,b as lt,d as pt,m as xt,a as At,t as yt,e as Tt}from"../chunks/index.9ced2dbd.js";import{b as rt}from"../chunks/paths.b4472117.js";import{s as St,g as D}from"../chunks/gameloop.45755ab9.js";import{N as Gt}from"../chunks/Navigation.128e6f86.js";function wt(t){const e=[-.5,.5,-.5,-.5,.5,.5,.5,-.5],n=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,n),t.bufferData(t.ARRAY_BUFFER,new Float32Array(e),t.STATIC_DRAW);const r=[0,0,0,1,1,0,1,1],i=t.createBuffer();return t.bindBuffer(t.ARRAY_BUFFER,i),t.bufferData(t.ARRAY_BUFFER,new Float32Array(r),t.STATIC_DRAW),{positionBuffer:n,textureCoordBuffer:i}}function Ot(t){const e=`
attribute vec2 aVertexPosition;
attribute vec2 aTextureCoord;

uniform mat4 uProjectionMatrix;

varying highp vec2 vTextureCoord;

void main(void) {
    gl_Position = uProjectionMatrix * vec4(aVertexPosition, 0.0, 1.0);
    vTextureCoord = aTextureCoord;
}
	`,n=`
		varying highp vec2 vTextureCoord;
		uniform sampler2D uSampler;
		uniform highp float uWhiteFlash; // Uniform for white flash effect

		void main(void) {
			// Sample the texture color
			highp vec4 texColor = texture2D(uSampler, vTextureCoord);

			// Blend texture color with white based on uWhiteFlash value
			highp vec4 whiteColor = vec4(1.0, 1.0, 1.0, texColor.a);
			gl_FragColor = mix(texColor, whiteColor, uWhiteFlash);
		}
	`,r=ot(t,t.VERTEX_SHADER,e),i=ot(t,t.FRAGMENT_SHADER,n),a=t.createProgram();return t.attachShader(a,r),t.attachShader(a,i),t.linkProgram(a),t.getProgramParameter(a,t.LINK_STATUS)?(t.useProgram(a),a):(console.error("Unable to initialize the shader program:",t.getProgramInfoLog(a)),null)}function ot(t,e,n){const r=t.createShader(e);return r?(t.shaderSource(r,n),t.compileShader(r),t.getShaderParameter(r,t.COMPILE_STATUS)?r:(console.error("An error occurred compiling the shaders:",t.getShaderInfoLog(r)),t.deleteShader(r),null)):(console.error("Unable to create shader"),null)}function Nt(t){const e=t.getContext("webgl",{alpha:!0});if(!e)return console.error("Unable to initialize WebGL. Your browser may not support it."),null;const n=Ot(e);if(!n)return console.error("Failed to initialize shader program"),null;const r=wt(e);return e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),e.clearColor(0,0,0,1),{gl:e,shaderProgram:n,buffers:r}}var st=typeof Float32Array<"u"?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)});function Wt(){var t=new st(16);return st!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}function $t(t,e,n,r,i,a,u){var d=1/(e-n),m=1/(r-i),s=1/(a-u);return t[0]=-2*d,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*m,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*s,t[11]=0,t[12]=(e+n)*d,t[13]=(i+r)*m,t[14]=(u+a)*s,t[15]=1,t}var jt=$t;function zt(t,e,n,r,i,a){const u=new Float32Array([0,0,0,t.canvas.height,t.canvas.width,0,t.canvas.width,t.canvas.height]);t.bindBuffer(t.ARRAY_BUFFER,n),t.bufferData(t.ARRAY_BUFFER,u,t.STATIC_DRAW);const d=t.getAttribLocation(e,"aVertexPosition");t.enableVertexAttribArray(d),t.vertexAttribPointer(d,2,t.FLOAT,!1,0,0),t.bindTexture(t.TEXTURE_2D,i.texture),t.bindBuffer(t.ARRAY_BUFFER,r);const m=new Float32Array([0,0,0,1,1,0,1,1]);t.bufferData(t.ARRAY_BUFFER,m,t.STATIC_DRAW);const s=t.getAttribLocation(e,"aTextureCoord");t.enableVertexAttribArray(s),t.vertexAttribPointer(s,2,t.FLOAT,!1,0,0);const p=t.getUniformLocation(e,"uSampler");t.uniform1i(p,0),t.uniform1f(a,0),t.drawArrays(t.TRIANGLE_STRIP,0,4)}let K,Q,Z,tt,ct,bt,et;function kt(t,e){({positionBuffer:K,textureCoordBuffer:Q}=wt(t)),Z=t.getAttribLocation(e,"aVertexPosition"),tt=t.getAttribLocation(e,"aTextureCoord"),ct=t.getUniformLocation(e,"uSampler"),bt=t.getUniformLocation(e,"uProjectionMatrix"),et=t.getUniformLocation(e,"uWhiteFlash"),t.enableVertexAttribArray(Z),t.enableVertexAttribArray(tt),t.uniform1i(ct,0)}function Ht(t,e,n,r,i,a){n.clear(n.COLOR_BUFFER_BIT);const u=Wt();jt(u,0,n.canvas.width,n.canvas.height,0,-1,1),n.uniformMatrix4fv(bt,!1,u);const d=i["/bg/current.png"];d&&zt(n,r,K,Q,d,et);const m=[...e,...a.filter(s=>s.draw)].sort((s,p)=>s.zIndex-p.zIndex);for(const s of m){const p=i[s.texturePath];if(p){const{x:T,y:F,scale:w,whiteFlash:A=0,angle:x=0}=s;Vt(n,r,K,Q,p,T,F,w,Z,tt,A,x,et,s.currentFrame)}else console.warn(`Texture not found for path: ${s.texturePath}`)}}function Vt(t,e,n,r,i,a,u,d,m,s,p=0,T=0,F,w){const{width:A,height:x,isGridFormat:R,gridRows:G=1,gridCols:_=1}=i;let v=new Float32Array([0,0,0,x,A,0,A,x]);const U=A/2,L=x/2,X=Math.cos(T),B=Math.sin(T);for(let b=0;b<v.length;b+=2){let E=v[b]-U,I=v[b+1]-L;E*=d,I*=d;const M=E*X-I*B,k=E*B+I*X;v[b]=M+a,v[b+1]=k+u}t.bindBuffer(t.ARRAY_BUFFER,n),t.bufferData(t.ARRAY_BUFFER,v,t.STATIC_DRAW),t.vertexAttribPointer(m,2,t.FLOAT,!1,0,0),t.enableVertexAttribArray(m),t.bindTexture(t.TEXTURE_2D,i.texture),t.bindBuffer(t.ARRAY_BUFFER,r);let O;if(R){const b=w%_,E=Math.floor(w/_),I=1/_,M=1/G;O=new Float32Array([b*I,E*M,b*I,(E+1)*M,(b+1)*I,E*M,(b+1)*I,(E+1)*M])}else O=new Float32Array([0,0,0,1,1,0,1,1]);t.bufferData(t.ARRAY_BUFFER,O,t.STATIC_DRAW),t.vertexAttribPointer(s,2,t.FLOAT,!1,0,0),t.enableVertexAttribArray(s),t.uniform1f(F,p),t.drawArrays(t.TRIANGLE_STRIP,0,4)}const Y=[{name:"flame10",path:"/abilities/flame10",frameCount:41},{name:"flame2",path:"/abilities/flame2",frameCount:16},{name:"slash3",path:"/abilities/slash3",frameCount:12},{name:"water10",path:"/abilities/water10",frameCount:14},{name:"water8",path:"/abilities/water8",frameCount:21},{name:"lightnings1_0000",path:"/abilities/lightnings1/0000.png",frameCount:9,isGridFormat:!0,gridRows:3,gridCols:3},{name:"lightnings1_0001",path:"/abilities/lightnings1/0001.png",frameCount:9,isGridFormat:!0,gridRows:3,gridCols:3},{name:"lightnings1_0002",path:"/abilities/lightnings1/0002.png",frameCount:16,isGridFormat:!0,gridRows:4,gridCols:4},{name:"lightnings1_0003",path:"/abilities/lightnings1/0003.png",frameCount:9,isGridFormat:!0,gridRows:3,gridCols:3}],qt=["/monster/card_001.png","/monster/card_002.png","/monster/card_003.png","/bg/current.png"];function q(t,e){return new Promise((n,r)=>{const i=t.createTexture();if(!i){r(new Error("Failed to create texture"));return}const a=new Image;a.crossOrigin="anonymous",a.src=rt+e,a.onload=()=>{t.bindTexture(t.TEXTURE_2D,i),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,a),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),n({texture:i,width:a.width,height:a.height,aspectRatio:a.width/a.height})},a.onerror=()=>{r(new Error(`Failed to load texture from ${e}`))}})}async function Jt(t){const e={};await Promise.all(qt.map(async n=>{try{const r=await q(t,n);e[n]=r}catch(r){console.error(r)}}));for(const n of Y)if(n.isGridFormat)try{const r=await q(t,n.path);e[n.path]={...r,isGridFormat:!0,gridRows:n.gridRows,gridCols:n.gridCols}}catch(r){console.error(r)}else await Promise.all(Array.from({length:n.frameCount}).map(async(r,i)=>{const a=`${i.toString().padStart(4,"0")}.png`,u=`${n.path}/${a}`;try{const d=await q(t,u);e[u]=d}catch(d){console.error(d)}}));return e}function z(t,e=1,n=0){const r=new Audio(rt+t);r.playbackRate=e,r.currentTime=n,r.play()}function J(t,e,n=1,r=0){setTimeout(()=>{const i=new Audio(rt+t);i.playbackRate=n,i.play()},e)}const Kt=600,Rt=300,Qt=600,Zt=350;function te(t,e,n){const r=e.x-t.x,i=e.y-t.y,a=Math.atan2(i,r),u=Y.find(d=>d.name===n);return{currentFrame:0,duration:Kt,lastTime:0,startX:t.x,startY:t.y,endX:e.x,endY:e.y,abilityFolder:u,texturePath:u.isGridFormat?u.path:`/abilities/${n}/0000.png`,x:t.x-.12,y:t.y,scale:1,draw:!0,zIndex:3,angle:a}}function ee(t,e){const n=Y.find(r=>r.name===e);return{currentFrame:0,duration:Rt,lastTime:0,startX:t.x,startY:t.y,endX:t.x,endY:t.y,abilityFolder:n,texturePath:n.isGridFormat?n.path:`/abilities/${e}/0000.png`,x:t.x,y:t.y,scale:.7,draw:!0,zIndex:2,angle:0}}function re(t,e,n){const r=e.x-t.x,i=e.y-t.y,a=Math.atan2(i,r),u=Y.find(d=>d.name===n);return{currentFrame:0,duration:Qt,lastTime:0,startX:t.x,startY:t.y,endX:e.x,endY:e.y,abilityFolder:u,texturePath:u.isGridFormat?u.path:`/abilities/${n}/0000.png`,x:t.x-.12,y:t.y,scale:.5,draw:!0,zIndex:3,angle:a}}function ne(t,e){const n=Y.find(r=>r.name===e);return{currentFrame:0,duration:Zt,lastTime:0,startX:t.x+30,startY:t.y+35,endX:t.x,endY:t.y,abilityFolder:n,texturePath:n.isGridFormat?n.path:`/abilities/${e}/0000.png`,x:t.x+30,y:t.y+35,scale:1.2,draw:!0,zIndex:2,angle:Math.PI/2}}const Ft=500,ae=300;function ie(t,e,n){const r=e.x-t.x,i=e.y-t.y,a=Math.atan2(i,r),u=Y.find(s=>s.name===n),d=400,m=200;return{currentFrame:0,duration:Ft,lastTime:0,startX:t.x+d,startY:t.y+m,endX:e.x-d,endY:e.y+m,abilityFolder:u,texturePath:u.path,x:t.x+d,y:t.y+m,scale:1,draw:!0,zIndex:3,angle:a}}function oe(t,e){const n=Y.find(a=>a.name===e),r=40,i=-20;return{currentFrame:0,duration:ae,lastTime:0,startX:t.x+r,startY:t.y+i,endX:t.x+r,endY:t.y+i,abilityFolder:n,texturePath:n.path,x:t.x+i,y:t.y+i,scale:.7,draw:!0,zIndex:2,angle:0}}function se(t,e){const n=Y.find(i=>i.name===e),r=100;return{currentFrame:0,duration:Rt,lastTime:0,startX:t.x+r,startY:t.y,endX:t.x+r,endY:t.y,abilityFolder:n,texturePath:n.isGridFormat?n.path:`/abilities/${e}/0000.png`,x:t.x+r,y:t.y,scale:.75,draw:!0,zIndex:2,angle:Math.PI/4}}function ut(t,e){var w;const n=[],r=e.canvas.width,i=e.canvas.height,a=.15,u=.8,d=u-.3,m=.55,s=m-.45,p=m-.45*2,T=[[-u,m],[-d,m],[d,m],[u,m],[-u,s-a],[-d,s-a],[d,s-a],[u,s-a],[-u,p-a*2],[-d,p-a*2],[d,p-a*2],[u,p-a*2]],F=[0,1,4,5,8,9,2,3,6,7,10,11];for(let A=0;A<t.slots.length;A++){const x=t.slots[A],R=((w=x.creature)==null?void 0:w.playerId)||1,G=x.creature?`/monster/${x.creature.img}`:"",_=F[A],[v,U]=T[_],L=(v+1)/2*r,X=(1-U)/2*i,B=.66;n.push({slotIndex:A,playerId:R,texturePath:G,x:L,y:X,scale:B,zIndex:A==1?1:0,isHovered:!1,originalX:L,originalY:X})}return n}function ce(t,e){const i=10*Math.sin(e*.003);return{...t,y:t.originalY-i,scale:.8}}function ue(t){let e,n,r,i;return e=new Gt({}),{c(){lt(e.$$.fragment),n=Ct(),r=gt("canvas"),this.h()},l(a){pt(e.$$.fragment,a),n=Mt(a),r=Dt(a,"CANVAS",{class:!0}),Yt(r).forEach(V),this.h()},h(){Xt(r,"class","svelte-q52jml")},m(a,u){xt(e,a,u),it(a,n,u),it(a,r,u),t[1](r),i=!0},p:dt,i(a){i||(At(e.$$.fragment,a),i=!0)},o(a){yt(e.$$.fragment,a),i=!1},d(a){a&&(V(n),V(r)),Tt(e,a),t[1](null)}}}const P=1,fe=300,de=60,me=200;function he(t,e,n){let r,i,a,u,d={},m=[],s=[],p,T=[],F=[],w=null;const A=-20,x={Q:6,W:7,E:8,A:9,S:10,D:11};let R="lightning";async function G(){const c=Nt(r);c&&({gl:i,shaderProgram:a,buffers:u}=c,d=await Jt(i),kt(i,a),s=ut(D,i),_(),p=requestAnimationFrame(U))}function _(){if(r&&i){const c=window.devicePixelRatio||1,o=window.innerWidth,f=window.innerHeight;n(0,r.width=o*c,r),n(0,r.height=f*c,r),n(0,r.style.width=`${o}px`,r),n(0,r.style.height=`${f}px`,r),i.viewport(0,0,r.width,r.height),s=ut(D,i)}}function v(){i&&Object.values(d).forEach(({texture:c})=>i.deleteTexture(c)),d={}}function U(c){L(c),X(c),B(c),O(c),b(c),Ht(D,s,i,a,d,m),p=requestAnimationFrame(U)}function L(c){m.forEach(o=>{o.startTime||(o.startTime=c);const f=c-o.startTime,l=Math.min(f/o.duration,1);if(o.abilityFolder.isGridFormat){const h=o.abilityFolder.frameCount;o.currentFrame=Math.floor(l*(h-1))}else{const h=o.abilityFolder.frameCount;o.currentFrame=Math.floor(l*(h-1)),o.texturePath=`/abilities/${o.abilityFolder.name}/${o.currentFrame.toString().padStart(4,"0")}.png`}if(l>.3){const h=(l-.3)/.7;o.x=o.startX+(o.endX-o.startX)*h,o.y=o.startY+(o.endY-o.startY)*h}l>=1&&(o.draw=!1)}),m=m.filter(o=>o.draw)}function X(c){if(F.length===0){const o=D.activeCreature;if(o){const f=D.slots.findIndex(l=>{var h;return((h=l.creature)==null?void 0:h.bcId)===o.bcId});f!==-1&&s[f]&&(s[f]=ce(s[f],c))}}}function B(c){if(w&&s[P]){const o=c-w,f=Math.min(o/me,1),l=Math.sin(f*Math.PI);s[P].x=s[P].originalX+A*l,f>=1&&(s[P].x=s[P].originalX,w=null)}}function O(c){T=T.filter(o=>{const{targetSlotIndex:f,startTime:l}=o,h=s[f];if(!h)return!1;const N=c-l,C=Math.min(N/fe,1),g=Math.sin(C*Math.PI);return h.x=h.originalX+de*g,h.whiteFlash=.9*(1-C),C>=1?(h.x=h.originalX,h.whiteFlash=0,!1):!0})}function b(c){const o=f=>f*f*f;F=F.filter(f=>{const{slotIndex:l,targetSlotIndex:h,startTime:N,duration:C,startX:g,startY:S,targetX:$,targetY:j,jumpHeight:vt,phase:at}=f,y=s[l];if(!y)return!1;const Et=c-N,W=Math.min(Et/C,1),H=o(W);if(at==="jump")if(y.x=g+($-g)*H,y.y=S+(j-S)*H-vt*Math.sin(H*Math.PI),W>=1){z("/mp3/punch2.mp3",1,0);const It=s[h],Pt=se(It,"slash3");return m.push(Pt),T.push({targetSlotIndex:h,startTime:performance.now()}),f.startTime=c,f.duration=C/1.2,f.phase="return",f.startX=y.x,f.startY=y.y,f.targetX=y.originalX,f.targetY=y.originalY,!0}else return!0;else if(at==="return")return y.x=g+($-g)*W,y.y=S+(j-S)*W,W>=1?(y.x=y.originalX,y.y=y.originalY,y.isHovered=!0,!1):!0})}function E(c){const o=s[P],f=s[c];z("/mp3/fireball.mp3",1,0);const l=te(o,f,"flame10");m.push(l),w=performance.now(),J("/mp3/blast.mp3",350,1.1),setTimeout(()=>{const h=ee(f,"flame2");m.push(h),T.push({targetSlotIndex:c,startTime:performance.now()})},500)}function I(c){const o=s[P],f=s[c];z("/mp3/water/22.mp3",1,0);const l=re(o,f,"water8");m.push(l),w=performance.now(),J("/mp3/water/46.mp3",350,1.1),setTimeout(()=>{const h=ne(f,"water10");m.push(h),T.push({targetSlotIndex:c,startTime:performance.now()})},500)}function M(c){const o=s[P],f=s[c],l=ie(o,f,"lightnings1_0003");m.push(l),z("/mp3/lightning/16.mp3",1.3,0),J("/mp3/lightning/06.mp3",300,1),setTimeout(()=>{const h=oe(f,"lightnings1_0000");m.push(h),T.push({targetSlotIndex:c,startTime:performance.now()})},Ft)}function k(c){const o=s[P],f=s[c],l=300,h=150,N=330,C=o.originalX,g=o.originalY,S=f.x-N*Math.sign(f.x-o.x),$=f.y;o.x=C,o.y=g,o.isHovered=!1;const j={slotIndex:P,targetSlotIndex:c,startTime:performance.now(),duration:l,startX:C,startY:g,targetX:S,targetY:$,jumpHeight:h,phase:"jump"};F.push(j)}function nt(c){const o=c.key.toUpperCase();o==="1"?R="fireball":o==="2"?R="waterball":o==="3"?R="lightning":o==="4"?R="jumpAttack":x[o]!==void 0&&(R==="lightning"?setTimeout(()=>{M(x[o])},1e4):R==="fireball"?E(x[o]):R==="waterball"?I(x[o]):R==="jumpAttack"&&k(x[o]))}Ut(()=>{St(D),D.activeCreature=D.slots[1].creature,G(),window.addEventListener("keydown",nt),window.addEventListener("resize",_),_()}),Lt(()=>{window.cancelAnimationFrame(p),v(),i&&a&&u&&(i.deleteProgram(a),i.deleteBuffer(u.positionBuffer),i.deleteBuffer(u.textureCoordBuffer)),window.removeEventListener("keydown",nt),window.removeEventListener("resize",_)});function _t(c){Bt[c?"unshift":"push"](()=>{r=c,n(0,r)})}return[r,_t]}class le extends mt{constructor(e){super(),ht(this,e,he,ue,ft,{})}}function pe(t){let e,n;return e=new le({}),{c(){lt(e.$$.fragment)},l(r){pt(e.$$.fragment,r)},m(r,i){xt(e,r,i),n=!0},p:dt,i(r){n||(At(e.$$.fragment,r),n=!0)},o(r){yt(e.$$.fragment,r),n=!1},d(r){Tt(e,r)}}}class be extends mt{constructor(e){super(),ht(this,e,null,pe,ft,{})}}export{be as component};
